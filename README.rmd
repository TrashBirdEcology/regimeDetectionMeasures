---
title: "regimeDetectionMeasures: An R Package for Calculating Multiple Regime Detection Measures"
date: "Last updated: `r Sys.Date()`"
author: "Jessica L. Burnett"
output: github_document
tags: [regime shift, ecology]
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo=TRUE, fig.align='center', out.width = "85%")
```

# About 

This package calculates various regime detection metrics that have been used to detect ecological regime shifts. A 'new' metric, distance travelled (and the velocity of distance travelled) is also calculated.  Functions for calculating the  following regime detection measures

## Using multivariable data
The  COMPOSITE metrics can handle an infinite number of state variables, and will return a single measurement at each time point.
1. Distance travelled -see also package [`distanceTravelled`](https://github.com/TrashBirdEcology/distanceTravelled). 
1. Fisher Information (moving window and velocity methods)
1. Variance Index

## Using univariate data
Univariate metrics are calculated using a moving-window analysis and can handle only individual state variables. That is, you will get one measurement per state variable. 
1. Skewness (options for mean and mode skewness)
1. Kurtosis
1. Variance
1. Mean
1. Mode
1. Coefficient of variation (CV)
1. Autocorrelation lag-1


# Quick Overview of Package Functionality
## Install 
```{r, echo=TRUE, warning=FALSE, message=FALSE}
devtools::install_github("trashbirdecology/regimedetectionmeasures", force=FALSE, dependencies = TRUE)
library(regimeDetectionMeasures)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot2::theme_set(theme_bw())
```


## Example Data
The function `get_example_data()` retrieves a multivariable times series comprising observations from a soil core from Foy Lake, Montana [Spanbauer et al. 2014](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0108936)). 

```{r, echo=TRUE, message=FALSE}
data <-  get_example_data()
```

__Alternatively, provide your own data with columns__:
`site`: unique site id; if your data has only a single site, specify that.
`sortVar`: the spatial or temporal index of interest (i.e., "the x-axis"). 
`variable`: units of interest (e.g., species identities)
`value`: measurements of variable (e.g., relative abundance)
```{r, eval=TRUE, echo=FALSE}
head(data, 2)
```

IMPORTANT STEP: arrange your data by the sorting variable (sortVar):
```{r, eval=TRUE, echo=TRUE}
data <-  arrange(data, .by_group = sortVar)
```

## Visualize the original data
Here, we quickly visualize the paleodiatom time series
```{r, echo=TRUE}
plot_orig_data(data = data, x.lab="time", example=TRUE)
```

### Units elpased between observations
We can also inspect the time elapsed between our observations along the `sortVar` (here, along time) using `plot_time_elapsed()`. Notice the considerable change in sampling frequency in the example data:
```{r, fig.cap= "Sampling is irregular for the paleodiatom example data from Spanbauer et al. (2014).",  message=FALSE}
plot_time_elapsed(data = data, example = TRUE, x.lab="time")
```

## Unique state variables over time
Quickly plot the change in unique number of state variables over time. This is particularly of interest for community species richess over time:
```{r, fig.cap = "Species richness exhibits a sharp decline before time=-2000."}
plot_richness(data,
              example = TRUE,
              print = TRUE 
              )
```

# Calculate Regime Detection Measures
## Velocity and Distance Travelled

Next, we want to calculate the distance travelled, velocity, and acceleration measures. This requires the data input to have the following column names: c("sortVar", "variable","value"). If the column 'site' exists, and multiple sites are sampled, then the metrics will be calculated at each site independent of one another.

```{r, echo=TRUE}
distances <- calc_distance(data, get.derivs =  TRUE, long.format=TRUE) 
```

- ds: this is the total change in system variables between the current and previous time point. This value can take on any number or sign, and is uniquely calculated for every time step **except the first**
- s: this the the *distance travelled* metric. It is used to calculate the velocity (*dsdt*), and is calculated at each time step as the cumulative sum of **s**.
- dsdt (*v*): this is the velocity measurement. It is calculated as the speed of **S** at each time step. This is the first derivative of **s**, **s^'**
-d2sdt2: this is the acceleration of **s** at each time step. This is the second derivative of **s**, **s^''**.


## Fisher Information, Variance Index, and typical Early Warning Signals
Using a moving window analysis, function `rdm_window_analysis` calculates Fisher Information, Variance Index, and other univariate early warning signals. Results are provided in a 'long' format. This function requires a dataset with only a site, unique `site`, if the site column exists
```{r}
ews.results <- rdm_window_analysis(data)
glimpse(ews.results)
```


Note the default of this function is to return VI (variance index), FI (fisher information), central tendencies and variance, CV (coefficient of variation), and skewness (using the mean and mode calculations):
```{r}
ews.results %>% distinct(metricType)
```


# Visualize the Results

## Fisher Information & Variance Index
Use any method to visualize the results. Here, we use `ggplot` to visualize FI and VI, since these are metrics obtained for multiple species over time, rather than a single species over time.
```{r}
fi.vi <- ews.results %>% filter(metricType  %in% c("FI_Eqn7.12", "VI"))

# Visualize using the window stop time, since these were moving window anlayses
ggplot(data = fi.vi, aes(x=winStop, y = metricValue))+
    geom_point() +
    facet_wrap(~metricType, scales = "free_y")
```


## Distance Travelled and Velocity
Use any method to visualize the results. Here, we use `ggplot` to visualize the distance travelled and the velocity of the distance travelled.
```{r}

# Visualize using the window stop time, since these were moving window anlayses
ggplot(data = distances, aes(x=sortVar, y = metricValue))+
    geom_line() +
    facet_wrap(~metricType, scales = "free_y")+xlab("years before 1950")
```

